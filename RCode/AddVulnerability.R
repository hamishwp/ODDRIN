# source('RCode/GetINFORM.R')

AddGDP<-function(ODDobj,inds=NULL,GDP=NULL){
  
  if(is.null(GDP)) GDP<-GetKummu(ODDobj@dir,c(ODDobj@bbox))
  # Minimise computation if only one GDP value is found
  if(length(unique(GDP@data$GDP))==1) { #LOOSEEND: should be GDP@data$X2015 ? 
    ODDobj$GDP<-rep(unique(GDP@data$GDP),length(ODDobj@data$Population))
    ODDobj$GDP[is.na(ODDobj$Population)]<-NA
    return(ODDobj)
  }
  ODDobj$GDP<-NA
  # interpolate data onto a regular grid
  if(!is.null(inds)) {
    ODDobj$GDP[inds]<-GDP%>%raster%>%raster::extract(ODDobj@coords[inds,])
  } else {
    ODDobj$GDP<-GDP%>%raster%>%raster::extract(ODDobj@coords)
  }
  
  # The Kummu dataset is not high resolution, 
  # Therefore, sometimes Pop data exists but GDP doesn't
  # We fix this by using the nearest-neighbour extrapolation
  GDP%<>%as.data.frame()
  for (i in which(!is.na(ODDobj$Population)&is.na(ODDobj$GDP))){
    # Find the index of the closest non-NA GDP value by longitude & latitude
    # NOTE: the end term is to ensure NA's are removed
    iminnie<-which.min((ODDobj@coords[i,1]-GDP[,2])^2*(ODDobj@coords[i,2]-GDP[,3])^2 + GDP[,1]/GDP[,1])
    ODDobj$GDP[i]<-GDP[iminnie,1]
  }
  
  return(ODDobj)
  
}

GetGlobalDataLab<-function(ODDy){
  # Extract required countries from ODD object
  ODDisos<-unique(ODDy@data$ISO3C)
  # Remove erroneous values:
  # if(length(!is.na(ODDy@data$Population) & is.na(ODDy@data$ISO3C))>0) ODDy@data$Population[!is.na(ODDy@data$Population) & is.na(ODDy@data$ISO3C),]<-NULL
  # Check the files exist first
  if(!(file.exists(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/GDL Shapefiles V6/shdi2022_World_large.shp")) &
     file.exists(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/SHDI-SGDI-Total 5.0.csv")))) stop("Please download the vulnerability data & shapefiles here: https://globaldatalab.org/asset/348/SHDI-SGDI-Total%205.0.csv and https://globaldatalab.org/asset/378/GDL%20Shapefiles%20V6.zip and put into './Demography_Data/SocioEconomic/GlobalDataLab/'. Note that you'll have to create an account with the GDL first.")
  # Get the data
  GDLdata<-read.csv2(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/SHDI-SGDI-Total 5.0.csv"),sep = ",")
  GDLdata%<>%filter(level=="Subnat")%>%
    dplyr::select(-c(country,level,region,continent,sgdi,shdi,shdif,shdim,
                     healthindexf,healthindexm,healthindex,incindex,incindexf,incindexm,
                     edindex,edindexf,edindexm,eschf,eschm,msch,mschf,mschm,
                     lifexpf,lifexpm,gnicf,gnicm,lgnic,lgnicf,lgnicm,pop,mfsel))%>%
    as.data.frame()
  # Convert to numerical values from characters
  for(i in c(2,4:length(GDLdata))) GDLdata[,i]%<>%as.numeric()
  # Rename to make more sense
  colnames(GDLdata)[4:ncol(GDLdata)]<-c("ExpectedSchoolYrs","LifeExp","GrossNatInc")
  if(!any(ODDisos%in%unique(GDLdata$iso_code))) stop(paste0("not all ODD-object countries exist in GDL vulnerability data"))
  # Only include the countries (observed to have been) impacted by the hazard:
  GDLdata%<>%filter(iso_code%in%ODDisos)
  # Nearest neighbour year value
  for(iso in unique(GDLdata$iso_code)) {
    yr<-(GDLdata$year[GDLdata$iso_code==iso])[which.min(abs(GDLdata$year[GDLdata$iso_code==iso]-AsYear(min(ODDy@hazdates,na.rm = T))))]
    GDLdata%<>%filter((iso_code==iso & year==yr) | iso_code!=iso)
  }
  # Get the associated shapefiles
  GDLshape<-sf::st_read(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/GDL Shapefiles V6/shdi2022_World_large.shp"))
  # Filter for only countries (observed to be) impacted by hazard
  GDLshape<-GDLshape[!is.na(GDLshape$iso_code) & GDLshape$iso_code%in%ODDisos,]%>%as("Spatial")
  # To ensure consistent CRS
  crs_wgs84 <- CRS(SRS_string = "EPSG:4326")
  # Ensure Coordinate Reference System is the same as ODD object
  GDLshape<-spTransform(GDLshape,crs_wgs84)
  # Pull out all required ODD pixel grid-points
  indies<-!is.na(ODDy@data$Population)
  # Reduce ODD object to current iso only
  miniODD<-ODDy[indies,]; miniODD@data$GDLCODE<-NA
  # Ensure CRS is consistent
  miniODD<-spTransform(miniODD,crs_wgs84)
  # Take the union of the polygons and points
  miniODD$GDLCODE<-over(miniODD,GDLshape)%>%pull(gdlcode)
  # Prepare template
  ODDy@data$GDLCODE<-NA
  # Append the GDLCODEs to the ODD object:
  ODDy@data$GDLCODE[indies]<-miniODD@data$GDLCODE
  # Merge into the ODD object data dataframe
  ODDy@data%<>%merge(dplyr::select(GDLdata,-iso_code,-year),by="GDLCODE",all.x=T)
  ODDy@data$GDLCODE<-NULL
  
  return(ODDy)
}

GetHazCovars<-function(ODDy){
  
 if(ODDy@hazard=="EQ"){
   # Check the files exist first
   if(!(file.exists(paste0(dir,"Hazard_Data/global_vs30_tif/global_vs30.tif")) &
        file.exists(paste0(dir,"gdpga/gdpga.asc")))) stop("Please download the hazard frequency data here: https://sedac.ciesin.columbia.edu/data/set/ndh-earthquake-distribution-peak-ground-acceleration/data-download and https://earthquake.usgs.gov/data/vs30/. Note you'll have to create a SEDAC account.")
   # Add ground stiffness indicator
   stiff<-raster(paste0(dir,"Hazard_Data/global_vs30_tif/global_vs30.tif"))
   # Sort CRS
   projection(stiff)<-"+proj=longlat +datum=WGS84 +no_defs"
   # Crop bounding box to the ODD object
   ext <- GetExtent(ODDy,expander=1.1)
   stiff%<>%crop(ext)
   # Add to the ODD object!
   ODDy$Stiff<-stiff%>%raster::extract(ODDy,method='bilinear',fun=max,na.rm=T)%>%as.numeric()%>%log10()
   # Add EQ frequency (SEDAC data)
   
   
   
   
   
   return(ODDy)
 } else stop("Not ready for other hazards yet")
  
}

AddVuln<-function(ODDy){
  # Add the systemic vulnerabilities
  ODDy%<>%GetGlobalDataLab()
  # Add the hazard vulnerabilities
  ODDy%<>%GetHazCovars()
  return(ODDy)
}














