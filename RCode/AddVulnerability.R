# source('RCode/GetINFORM.R')

AddGDP<-function(ODDobj,inds=NULL,GDP=NULL){
  
  if(is.null(GDP)) GDP<-GetKummu(ODDobj@dir,c(ODDobj@bbox))
  # Minimise computation if only one GDP value is found
  if(length(unique(GDP@data$GDP))==1) { #LOOSEEND: should be GDP@data$X2015 ? 
    ODDobj$GDP<-rep(unique(GDP@data$GDP),length(ODDobj@data$Population))
    ODDobj$GDP[is.na(ODDobj$Population)]<-NA
    return(ODDobj)
  }
  ODDobj$GDP<-NA
  # interpolate data onto a regular grid
  if(!is.null(inds)) {
    ODDobj$GDP[inds]<-GDP%>%raster%>%raster::extract(ODDobj@coords[inds,])
  } else {
    ODDobj$GDP<-GDP%>%raster%>%raster::extract(ODDobj@coords)
  }
  
  # The Kummu dataset is not high resolution, 
  # Therefore, sometimes Pop data exists but GDP doesn't
  # We fix this by using the nearest-neighbour extrapolation
  GDP%<>%as.data.frame()
  for (i in which(!is.na(ODDobj$Population)&is.na(ODDobj$GDP))){
    # Find the index of the closest non-NA GDP value by longitude & latitude
    # NOTE: the end term is to ensure NA's are removed
    iminnie<-which.min((ODDobj@coords[i,1]-GDP[,2])^2*(ODDobj@coords[i,2]-GDP[,3])^2 + GDP[,1]/GDP[,1])
    ODDobj$GDP[i]<-GDP[iminnie,1]
  }
  
  return(ODDobj)
  
}

readGlobalDataLab <- function(){
  # Check the files exist first
  if(!(file.exists(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/GDL Shapefiles V6/shdi2022_World_large.shp")) &
       file.exists(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/SHDI-SGDI-Total 7.0.csv")))) stop("Please download the vulnerability data & shapefiles here: https://globaldatalab.org/asset/348/SHDI-SGDI-Total%207.0.csv and https://globaldatalab.org/asset/378/GDL%20Shapefiles%20V6.zip and put into './Demography_Data/SocioEconomic/GlobalDataLab/'. Note that you'll have to create an account with the GDL first.")
  # Get the data
  GDLdata<-read.csv2(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/SHDI-SGDI-Total 7.0.csv"),sep = ",")
  GDLdata%<>%filter(level=="Subnat")%>%
    dplyr::select(c(iso_code, year, GDLCODE, msch, lifexp, gnic, shdi)) %>%
    as.data.frame()
  
  #-c(country,level,region,continent,shdi, sgdi,shdif,shdim,
  # healthindexf,healthindexm,healthindex,incindex,incindexf,incindexm,
  # edindex,edindexf,edindexm,esch, eschf,eschm,mschf,mschm,
  # lifexpf,lifexpm,gnicf,gnicm,lgnic,lgnicf,lgnicm,pop,mfsel)
  
  # Convert to numerical values from characters
  for(i in c(2,4:length(GDLdata))) GDLdata[,i]%<>%as.numeric()
  # Rename to make more sense
  colnames(GDLdata)[4:ncol(GDLdata)]<-c("AveSchYrs","LifeExp","GNIc", 'SHDI')
  return(GDLdata)
}

GetGlobalDataLab<-function(ODDy){
  # Extract required countries from ODD object
  ODDisos <- unique(ODDy$ISO3C)$ISO3C
  # Remove erroneous values:
  # if(length(!is.na(ODDy@data$Population) & is.na(ODDy@data$ISO3C))>0) ODDy@data$Population[!is.na(ODDy@data$Population) & is.na(ODDy@data$ISO3C),]<-NULL
  
  GDLdata <- readGlobalDataLab()
  
  if(!any(ODDisos%in%unique(GDLdata$iso_code))) {
    #stop(paste0("not all ODD-object countries exist in GDL vulnerability data"))
    print('Country does not exist in GDL vulnerability data')
    demography_non_GDL <- read.csv(paste0(dir,"Demography_Data/SocioEconomic/NonGlobalDataLab/DemographyDat_nonGDL"))
    df_ISO3C <- data.frame(ISO3C=levels(ODDy[['ISO3C']])[[1]]$VALUE[values(ODDy[['ISO3C']])])
    df_ISO3C$order <- 1:NROW(df_ISO3C)
    df_ISO3C <- merge(df_ISO3C, demography_non_GDL %>% filter(year==unique(year(ODDy@hazdates))) %>% dplyr::select(-year),by="ISO3C",all.x=T, sort=F)
    ODDy[['SHDI']] <- df_ISO3C$SHDI
    ODDy[['GNIc']] <- df_ISO3C$GNIc
    return(ODDy)
  }
  # Only include the countries (observed to have been) impacted by the hazard:
  GDLdata%<>%filter(iso_code%in%ODDisos)
  # Nearest neighbour year value
  for(iso in unique(GDLdata$iso_code)) {
    yr<-(GDLdata$year[GDLdata$iso_code==iso])[which.min(abs(GDLdata$year[GDLdata$iso_code==iso]-AsYear(min(ODDy@hazdates,na.rm = T))))]
    GDLdata%<>%filter((iso_code==iso & year==yr) | iso_code!=iso)
  }
  # Get the associated shapefiles
  GDLshape<-sf::st_read(paste0(dir,"Demography_Data/SocioEconomic/GlobalDataLab/GDL Shapefiles V6/shdi2022_World_large.shp"))
  # Filter for only countries (observed to be) impacted by hazard
  GDLshape<-GDLshape[!is.na(GDLshape$iso_code) & GDLshape$iso_code%in%ODDisos,] #%>%as("Spatial")
  # To ensure consistent CRS
  #crs_wgs84 <- CRS(SRS_string = "EPSG:4326")
  # Ensure Coordinate Reference System is the same as ODD object
  #GDLshape<-spTransform(GDLshape,crs_wgs84)
  # Pull out all required ODD pixel grid-points
  #indies<-!is.na(values(ODDy[['Population']]))
  # Reduce ODD object to current iso only
  #miniODD<-ODDy[indies,]; miniODD@data$GDLCODE<-NA
  
  #miniODD@data$GDLCODE<-NA
  # Ensure CRS is consistent
  #miniODD<-spTransform(miniODD,crs_wgs84)
  # Take the union of the polygons and points
  #miniODD$GDLCODE<-over(miniODD,GDLshape)%>%pull(gdlcode)
  
  rasterized_gdl <- rasterize(GDLshape, ODDy, field = "gdlcode")
  gdlcode_values <- values(rasterized_gdl)
  
  #find which rows are missing GDL data but have population data
  missing_GDL <- which(is.na(gdlcode_values) & !is.na(values(ODDy[['Population']])))
  
  if (length(missing_GDL) > 0){
    coords_missing_GDL <- st_as_sf(data.frame(xyFromCell(ODDy, missing_GDL)), coords = c("x", "y"), crs = crs(ODDy))
    dists <- st_distance(coords_missing_GDL, GDLshape)
    closest_polygon_id <- apply(dists, 1, which.min)
    gdlcode_values[missing_GDL] = closest_polygon_id
    
    closest_polygon_dists <- apply(dists,1,min)
    rounded_dists_table <- table(round(closest_polygon_dists/5000)*5)
    warning_text <- sprintf(paste(c('Number of pixels Xkm from the nearest GDL data:\n', paste0(names(rounded_dists_table), 'km: ', rounded_dists_table, '\n')), collapse=' '))
    warning(warning_text)
    furthest_pixel <- which.max(closest_polygon_dists)
    warning(paste('Furthest pixel from GDL data:',coords_missing_GDL$geometry[[furthest_pixel]][1],coords_missing_GDL$geometry[[furthest_pixel]][2]))
    
    ## For each point, find id of nearest polygon
    # for (i in 1:NROW(coords_missing_GDL)) {
    #   gDists <- st_distance(coords_missing_GDL[i,], GDLshape) #gDistance(spdf_missing_GDL[i,], GDLshape, byid=TRUE)
    #   if (units(gDists)$numerator == 'm'){threshold = 1000}
    #   else {threshold = 0.0166667}
    #   print(min(gDists))
    #   #print(min(gDists))
    #   if(min(as.numeric(gDists)) > threshold){
    #     warning(paste('No GDL data within 1 arcminute of the populated pixel',coords_missing_GDL$geometry[[i]][1],coords_missing_GDL$geometry[[i]][2]))
    #     gdlcode_values[missing_GDL[i]] <- GDLshape$gdlcode[which.min(gDists)]
    #   } else {
    #     gdlcode_values[missing_GDL[i]] <- GDLshape$gdlcode[which.min(gDists)]
    #   }
    # }
  } 
  rasterized_gdl[1:ncell(rasterized_gdl)] <- gdlcode_values
  
  gdl_df <- data.frame(cbind(xyFromCell(rasterized_gdl, 1:ncell(rasterized_gdl)), layer=values(rasterized_gdl)))
  gdl_df$order <- 1:NROW(gdl_df)
  gdl_df <- merge(merge(gdl_df, levels(rasterized_gdl)[[1]], by.x='gdlcode', by.y='ID', all.x=T), GDLdata, by.x=c('gdlcode.y'), by.y=c('GDLCODE'), all.x=T)
  gdl_df <- gdl_df[order(gdl_df$order),]
  
  values(rasterized_gdl) <- gdl_df[['GNIc']]
  ODDy[['GNIc']] <- rasterized_gdl
  values(rasterized_gdl) <- gdl_df[['SHDI']]
  ODDy[['SHDI']] <- rasterized_gdl
  
  return(ODDy)
}


GetVS30<-function(ODDy){
  # Check the files exist first
  if(!file.exists(paste0(dir,"Hazard_Data/global_vs30_tif/global_vs30.tif"))) stop("Please download the VS30 dataset (geotiff and auxiliary files) here https://earthquake.usgs.gov/data/vs30/.")
  # Add ground stiffness indicator
  stiff<-rast(paste0(dir,"Hazard_Data/global_vs30_tif/global_vs30.tif"))
  # Sort CRS
  crs(stiff)<-"+proj=longlat +datum=WGS84 +no_defs"
  # Crop bounding box to the ODD object
  stiff%<>%crop(ext(ODDy))
  # Add to the ODD object!
  #ODDy$Vs30<-stiff%>%raster::extract(ODDy,method='bilinear',fun=max,na.rm=T)%>%
  #  as.numeric()
  ODDy[['Vs30']] <- resample(stiff, ODDy, method='bilinear')
  return(ODDy)
}

GetPGAFreq<-function(ODDy){
  # Check the files exist first
  # if(!file.exists(paste0(dir,"Hazard_Data/gdpga/gdpga.asc"))) stop("Please download the hazard frequency data here: https://sedac.ciesin.columbia.edu/data/set/ndh-earthquake-distribution-peak-ground-acceleration/data-download.  Note you'll have to create a SEDAC account.")
  #if(!file.exists(paste0(dir,"Hazard_Data/gdpga/pga_475y.tif"))) stop("Please download the hazard frequency data here: https://www.geonode-gfdrrlab.org/layers/hazard:pga_475y")
  if(!file.exists(paste0(dir, 'Hazard_Data/GEM-GSHM_PGA-475y-rock_v2023/v2023_1_pga_475_rock_3min.tif'))) stop("Please download the hazard frequency data here: https://www.globalquakemodel.org/product/global-seismic-hazard-map") #
  
  if(ext(ODDy)[1]<ext(ODDy)[2]){
    # pga<-SortDemoData(paste0(dir,"Hazard_Data/gdpga/gdpga.asc"))
    # pga%<>%convMat2SPDF(name="PGA")
    # 
    # pga_raster <- pga%>%raster() %>% crop(extent(ODDy@bbox+rbind(c(-0.2, 0.2), c(-0.2, 0.2))), snap='out')
    # 
    # #fill NA values using the mean of the 9 x 9 raster grid surrounding the NA cell
    # fill.na <- function(x, i=41) {
    #   if( is.na(x)[i] ) return( round(mean(x, na.rm=TRUE),0) )
    #   else return( round(x[i],0) )
    # }  
    # pga_raster_na_filled <- focal(pga_raster, w = matrix(1,9,9), fun = fill.na, pad = TRUE, na.rm = FALSE )
    
    pga <- rast(paste0(dir,"Hazard_Data/GEM-GSHM_PGA-475y-rock_v2023/v2023_1_pga_475_rock_3min.tif"))
    
    pga_cropped <- pga %>% crop(ext(ODDy), snap='out')
    
    ODDy[['EQFreq']] <- resample(pga_cropped, ODDy, method='bilinear')
    
    #ODDy@data$EQFreq<-pga_cropped%>%raster::extract(ODDy,method='bilinear',fun=max,na.rm=T)%>%as.numeric()
    
    #ODDy@data$EQFreq <- ODDy@data$EQFreq
    
  } else {
    # When the bounding box goes through the meridian. In the case of Fiji, for example.
    # bbox<-c(0,ODDy@bbox[2],ODDy@bbox[3],ODDy@bbox[4])
    # # Get the right hand side
    # pgaR<-SortDemoData(paste0(dir,"Hazard_Data/gdpga/gdpga.asc"),bbox)%>%convMat2SPDF(name="PGA")
    # bbox<-c(ODDy@bbox[1],ODDy@bbox[2],180,ODDy@bbox[4])
    # # Get the left hand side
    # pgaL<-SortDemoData(paste0(dir,"Hazard_Data/gdpga/gdpga.asc"),bbox)%>%convMat2SPDF(name="PGA")
    stop("Not possible to bind two SPDFs around the meridian... try splitting the object in two domains")
  }
  
  return(ODDy)
}

GetHazCovars<-function(ODDy){
  
  if(ODDy@hazard=="EQ"){
    # Add the VS30 stiffness dataset:
    ODDy%<>%GetVS30()
    # Add EQ frequency (SEDAC data)
    ODDy%<>%GetPGAFreq()
    
    return(ODDy)
  } else stop("Not ready for other hazards yet")
  
}

AddVuln<-function(ODDy){
  # Add the systemic vulnerabilities
  ODDy%<>%GetGlobalDataLab()
  # Add the hazard vulnerabilities
  ODDy%<>%GetHazCovars()
  ODDy[['PDens']] <- ODDy[['Population']]
  return(ODDy)
}


# Global Data Lab doesn't contain data on all countries. Have collected data from miscellaneous sources to fill in the gaps:
# not always for the correct year / exactly correct format but should be in the righ ballpark.
# GNI should be Gross National Income per capita (PPP, 2011 US$)
if (!file.exists(paste0(dir,"Demography_Data/SocioEconomic/NonGlobalDataLab/DemographyDat_nonGDL"))){
  demography_non_GDL <- data.frame(ISO3C=character(), SHDI=double(), AveSchYrs=double(), LifeExp=double(), GNIc=double(), year=integer())
  demography_non_GDL %<>% add_row(ISO3C='TWN', 
                                  SHDI=0.882, # 2014 https://bti-project.org/fileadmin/api/content/en/downloads/reports/country_report_2018_TWN.pdf
                                  AveSchYrs=12.1, #cannot find data for 2016 so using https://www3.weforum.org/docs/GCR2018/03CountryProfiles/WEF_GCI4_2018_Profile_Taiwan,_China.pdf
                                  LifeExp=80.69, #https://www.statista.com/statistics/861001/taiwan-life-expectancy/
                                  GNIc=26000, #Not PPP or standardised to 2011, but hopefully a close estimate https://www.ceicdata.com/en/taiwan/sna-08-reference-year2011-gdp-by-expenditure-current-price/gross-national-income-usd-per-capita
                                  year=2018) #https://www3.weforum.org/docs/GCR2018/03CountryProfiles/WEF_GCI4_2018_Profile_Taiwan,_China.pdf
  demography_non_GDL %<>% add_row(ISO3C='TWN', 
                                  SHDI=0.882, # 2014 https://bti-project.org/fileadmin/api/content/en/downloads/reports/country_report_2018_TWN.pdf
                                  AveSchYrs=12.1, # https://www3.weforum.org/docs/GCR2018/03CountryProfiles/WEF_GCI4_2018_Profile_Taiwan,_China.pdf
                                  LifeExp=80, #Not PPP and have multiplied quarterly by 4, bu hopefully a close estimate https://www.ceicdata.com/en/taiwan/sna-08-reference-year2011-gdp-by-expenditure-current-price/gross-national-income-usd-per-capita
                                  GNIc=24000, #Not PPP or standardised to 2011, but hopefully a close estimate https://www.ceicdata.com/en/taiwan/sna-08-reference-year2011-gdp-by-expenditure-current-price/gross-national-income-usd-per-capita
                                  year=2016) 
  # demography_non_GDL %<>% add_row(ISO3C='MNE', ExpSchYrs= 15.00, #https://ourworldindata.org/grapher/expected-years-of-schooling?tab=chart&country=MNE
  #                                 LifeExp=76.84, #World Data Bank, https://ourworldindata.org/grapher/life-expectancy-at-birth-total-years?tab=chart&country=MNE
  #                                 GNIc=20925.3471,#http://data.un.org/Data.aspx?d=WDI&f=Indicator_Code%3ANY.GNP.PCAP.PP.KD
  #                                 year=2018)
  demography_non_GDL %<>% add_row(ISO3C='PRI', 
                                  SHDI = 0.845, # in 2015, https://en.wikipedia.org/wiki/List_of_U.S._states_and_territories_by_Human_Development_Index
                                  AveSchYrs=12.9, #in 2017, http://data.uis.unesco.org/index.aspx?queryid=3803
                                  LifeExp=80.09, #World data bank, https://ourworldindata.org/grapher/life-expectancy-at-birth-total-years?tab=chart&country=PRI
                                  GNIc=23025.1886, #http://data.un.org/Data.aspx?d=WDI&f=Indicator_Code%3ANY.GNP.PCAP.PP.KD
                                  year=2020)
  demography_non_GDL %<>% add_row(ISO3C='SLB', 
                                  SHDI=0.56, #GDLdata %>% filter(iso_code =='SLB' & year==2016)
                                  AveSchYrs=5.4, #GDLdata %>% filter(iso_code =='SLB' & year==2016)
                                  LifeExp=72.4, #GDLdata %>% filter(iso_code =='SLB' & year==2016)
                                  GNIc=2240, #GDLdata %>% filter(iso_code =='SLB' & year==2016)
                                  year=2016)
  demography_non_GDL %<>% add_row(ISO3C='CYP', 
                                  SHDI = 0.871, #GDLdata %>% filter(iso_code =='CYP' & year==2015)
                                  AveSchYrs=11.9, #GDLdata %>% filter(iso_code =='CYP' & year==2015)
                                  LifeExp=80.3, #GDLdata %>% filter(iso_code =='CYP' & year==2015)
                                  GNIc=34160, #GDLdata %>% filter(iso_code =='CYP' & year==2015)
                                  year=2015)
  
  if(!dir.exists(file.path(paste0(dir, "Demography_Data/SocioEconomic/NonGlobalDataLab/")))){
    dir.create(file.path(paste0(dir, "Demography_Data/SocioEconomic/NonGlobalDataLab/")))
  }
  write.csv(demography_non_GDL, paste0(dir,"Demography_Data/SocioEconomic/NonGlobalDataLab/DemographyDat_nonGDL"), row.names=F)
}




